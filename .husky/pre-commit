#!/bin/sh
current_branch=$(git rev-parse --abbrev-ref HEAD)

# 1. Protect main branch (block commits to main)
if [ "$current_branch" = "main" ]; then
  echo "‚ùå Direct commits to 'main' are blocked. Please use a feature branch."
  exit 1
fi

# 2. Enforce branch naming convention
if [ "$current_branch" = "develop" ] || [ "$current_branch" = "main" ]; then
  # Allow base branches to bypass the prefix check
  :
else
  BRANCH_REGEX="^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|hotfix)\/[a-zA-Z0-9._-]+$"

  if ! echo "$current_branch" | grep -Eq "$BRANCH_REGEX"; then
    echo "‚ùå Invalid branch name: '$current_branch'"
    echo "Branches must start with a valid prefix: feat/, fix/, docs/, style/, refactor/, perf/, test/, build/, ci/, chore/, hotfix/"
    echo "Example: feat/add-login-form"
    echo "(Base branches like 'main' and 'develop' are also allowed)"
    exit 1
  fi
fi

# 3. Fast static checks
staged_ts_files=$(git diff --cached --name-only --diff-filter=ACMR | grep -E '\.(ts|tsx)$' || true)
if [ -n "$staged_ts_files" ]; then
  echo "üîç Running hygiene checks (json)..."
  if ! printf '%s\n' "$staged_ts_files" | xargs pnpm exec tsx scripts/check-hygiene.ts --format json; then
    echo "‚ùå Hygiene checks failed. Please fix the issues before committing."
    exit 1
  fi
fi

# 4. Lint staged changes
if FORCE_COLOR=0 pnpm lint-staged --quiet; then
  echo "‚úÖ Quality checks passed."
else
  exit 1
fi

# 5. Persist one-shot artifact for AI gatekeeper reuse
if ! pnpm exec tsx scripts/gatekeeper-report.ts --format json --skip-hygiene --lint-status pass --write-artifact > /dev/null; then
  echo "‚ö†Ô∏è Gatekeeper artifact generation failed. Commit continues; report script will regenerate on demand."
fi
